### RDB持久化

### 1.1 简要

`Redis`是一个键值对数据库服务器。

数据库状态：**指服务器中非空数据库以及它们的键值对**。

问题根源：

​		由于`Redis`是内存数据库，将数据库状态存储在内存里面，如果服务器进程退出，或出现宕机，那么内存中的数据库状态就会消失不见。

​		所以，`Redis`提供`RDB`持久化功能，这个功能可以把`Redis`在内存中的数据库状态保存到磁盘里面，避免数据意外丢失。

![image-20200922094832620](.\imges\image-20200922094832620.png)

### 1.2 `RDB`文件的创建与载入

​	有两个`Redis`命令可以用于生成`RDB`文件：`SAVE`、`BGSAVE`

其中 `save`命令会阻塞`Redis`服务器进程，知道`RDB`文件创建完毕为止，在阻塞期间，服务器不会处理任何命令请求。

```
redis> save          #等待知道RDB文件创建完成为止
ok
```

另外一个 `bgsave`则不同，执行`bgsave`命令会派生处一个子进程，该子进程负责创建`RDB`文件，，服务器进程(父进程)继续处理其它命令请求：

```
redis> bgsave   #派生子进程，由子进程进程创建RDB文件
Background saving started
```

注意：创建`RDB`文件的底层工作是**由`rdb.c/rdbSave`函数**完成的，两种命令只是以不同的方式调用该函数，以下伪代码实现两种区别：

伪代码：

```python
def SAVE():
    #创建RDB文件
    rdbSave()
    
def BGSAVE():
    #创建子进程
    pid = fork()
    if pid == 0:
        #子进程负责创建RDB文件
        rdbSave()
        #完成之后向父进程发送信号
        signal_parent()
    elif pid > 0:
        #父进程继续处理命令请求，并通过轮询等待子进程的信号
        handle_request_and_wait_signal()
    else:
    	#处理出错情况
        handle_fork_error()
```

​	`	RDB`文件的**载入工作是在服务器启动时自动执行的**，所以`Redis`并没有专门的用于载入`RDB`文件的命令，只要`Redis`服务器在启动时检测到`RDB`文件存在，就会自动的载入`RDB`文件。

另外**`AOF`文件的更新频率比`RDB`文件更新文件频率高**：

+ 如果服务器开启了`AOF`持久化功能，那么服务器**会优先使用`AOF`文件**来还原数据库状态。
+ 只有在`AOF`关闭的状态下，才会使用`RDB`文件来还原数据库状态。

![image-20200925133611575](.\imges\image-20200925133611575.png)

#### 1.2.1 `SAVE`命令执行时服务器状态

​	执行`save`命令，服务器**会被阻塞**，不能执行其它命令的请求，只能完成服务器才会去执行其它命令。

#### 1.2.2 `BGSAVE`命令执行时服务器状态

​	因为该命令是**子进程的方式**执行的，不会造成服务器的阻塞，服务器还是会继续处理其它命令。

​	注意：

+ `bgsave`执行期间，客户端**发送`save`命令会被服务器拒绝**，服务器禁止`save`和`bgsave`命令同时执行，避免父进程和子进程同时执行两个`rdbSave`调用，防止竞争条件。

+ `bgsave`执行期间，客户端**发送的`bgsave`命令会被服务器拒绝**，如果两个`bgsave`命令同时执行，会发生竞争。

+ **`bgwirteaof`和`bgsave`两个命令也不能同时执行**：

  + 如果`bgsave`正在执行，那么后续发送的`BGWIRTEAOF`命令会被延迟执行(等`bgsave`完成，在执行)

  + 如果`bgwirteaof`正在执行，那么发送的`bgsave`会被拒绝。

    因为：这两个命令都是子进程的形式进行运行的，其实并没有什么冲突的地方，只是考虑到性能，并发两个进程，执行大量的磁盘写入操作，所有`redis`限制了。

#### 1.2.3 `RDB`文件载入时的服务器状态

​	服务器在**载入`RDB`文件期间，会一直处于阻塞状态**，直到载入工作完成。

### 1.3 自动间隔性保存

#### 1.3.1 简要

​	`save`和`bgsave`的**主要区别**：前者由**服务器进程**执行保存操作；后者则由**子进程执行**保存操作。所以前者会阻塞，后者不会。

​	所以`Redis`允许用户通过设置**服务器配置的save选项**，让服务器在每个一段时间，执行一次`bgsave`命令。

​	可以通过save选项**设置多个保存条件**，但只要其中**任意一个条件满足**，服务器就会执行`bgsave`命令。

![image-20200925140336133](.\imges\image-20200925140336133.png)

![image-20200925140455511](.\imges\image-20200925140455511.png)

#### 1.3.2检查保存条件是否满足

`Redis`服务器**周期性操作函数`serverCron`函数**默认**每隔100毫秒**就会执行一次，，会对正在运行的服务器进行维护，其中有一项就是**检查 save选项中设置的条件是否已经满足**，满足的话会执行`bgsave`命令。

### 1.4 `RDB`文件结构

![image-20200925141959550](.\imges\image-20200925141959550.png)

上图所示：该结构**包含5个部分**

+ `REDIS`：为该文件最开头部分，长度 5个字节，保存`REDIS`五个字符；这样做是为了能看快速检查载入的**文件是否为`RDB`文件。**
+ `db_version`： 长度 4个字节，字符串表示的整数，**记录`RDB`文件的版本号**，比如 "0006" 代表`RDB`文件的版本为第六版。
+ `databases`： 包含0个或者多个数据库，以及各个数据库中的键值对数据
  + 如果服务器的**数据库状态为空(**所有库为空)，那么这个部分也就是**空**的，长度**为0 字节**
  + 如果服务器的**数据库状态非空**(至少1个库有数据)，那么这个部分也为 **非空**，根据数据库保存键值对的数量、类型、内容不同，那么这个**长度也就有所不同**的。
+ `EOF`：长度为 1个字节，**标志文件的正文内容的结束**，当读入程序遇到该值时候，说明数据库的所有键值对都已经载入完毕了。
+ `check_sum`：作为一个校验和，长度 8个字节的无符号整数，主要是`计算前面 4个部分内容进行计算出来的`。服务器载入`RDB`文件时，会将载入数据所计算的校验和 与 check_sum 所记录的校验和 **进行对比**，，以此来检查`RDB`文件**是否出错或者损坏的情况**出现。

![image-20200925143619122](.\imges\image-20200925143619122.png)

![image-20200925144241738](.\imges\image-20200925144241738.png)

#### 1.4.1 databases部分

![image-20200925144411867](.\imges\image-20200925144411867.png)

+ `SELECTDB`：常量的长度为 1 字节，当读到这个值时，他知道接下来**要读入的将是 一个数据库号码**
+ `db_number`：**保存数据库的号码**，当读到这个部分之后，服务器会**执行`select`命令**，进行数据库的切换。
+ `key_value_pairs`：部分保存了数据库中所有的键值对数据，如果过期了，那么过期时间也会和键值对保存一起。

![image-20200925145137344](.\imges\image-20200925145137344.png)

### 1.5 分析`RDB`文件

​	可以利用`od`命令来分析`Redis`服务器产生的`RDB`文件。 参数 -c 以`ASCII编码`方式打印输入文件。参数 -x 以 `十六制`的方式打印输入文件，等。

#### 1.5.1 不包含如何键值对的`RDB`文件

​	执行以下命令，创建一个数据库状态为 空 的`RDB`文件：

![image-20200925150054128](.\imges\image-20200925150054128.png)

![image-20200925150145343](.\imges\image-20200925150145343.png)

#### 1.5.2 包含字符串键的`RDB`文件

![image-20200925150607480](.\imges\image-20200925150607480.png)

#### 1.5.3 包含带有过期时间的字符串键的`RDB`文件

![image-20200925152920402](.\imges\image-20200925152920402.png)

#### 1.5.4 包含一个集合键的`RDB`文件

![image-20200925153125612](.\imges\image-20200925153125612.png)

![image-20200925153057701](.\imges\image-20200925153057701.png)

### 总结

![image-20200925153416646](.\imges\image-20200925153416646.png)